<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Family Calendar - Admin Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            color: #2d3748;
            margin-bottom: 10px;
            font-size: clamp(1.8rem, 4vw, 2.5rem);
            font-weight: 700;
        }

        .header p {
            color: #718096;
            font-size: clamp(1rem, 2vw, 1.1rem);
        }

        .nav-buttons {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }

        .nav-btn {
            background: #4299e1;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }

        .nav-btn:hover {
            background: #3182ce;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(66, 153, 225, 0.3);
        }

        .nav-btn.secondary {
            background: #e2e8f0;
            color: #4a5568;
        }

        .nav-btn.secondary:hover {
            background: #cbd5e0;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .section {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .section h2 {
            color: #2d3748;
            margin-bottom: 20px;
            font-size: clamp(1.4rem, 3vw, 1.8rem);
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section-icon {
            width: 24px;
            height: 24px;
            background: #4299e1;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 14px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #4a5568;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #4299e1;
            box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.1);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .btn {
            background: #48bb78;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        .btn:hover {
            background: #38a169;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(72, 187, 120, 0.3);
        }

        .btn.secondary {
            background: #e2e8f0;
            color: #4a5568;
        }

        .btn.secondary:hover {
            background: #cbd5e0;
        }

        .btn.danger {
            background: #f56565;
        }

        .btn.danger:hover {
            background: #e53e3e;
        }

        .btn.small {
            padding: 8px 16px;
            font-size: 0.9rem;
        }

        .list-container {
            max-height: 400px;
            overflow-y: auto;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            padding: 10px;
        }

        .list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            border-bottom: 1px solid #e2e8f0;
            transition: background-color 0.3s ease;
        }

        .list-item:hover {
            background-color: #f7fafc;
        }

        .list-item:last-child {
            border-bottom: none;
        }

        .list-item-info {
            flex: 1;
        }

        .list-item-title {
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 4px;
        }

        .list-item-details {
            font-size: 0.9rem;
            color: #718096;
        }

        .list-item-actions {
            display: flex;
            gap: 8px;
        }

        .color-preview {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 2px solid #e2e8f0;
            display: inline-block;
            margin-right: 8px;
            vertical-align: middle;
        }

        .status-message {
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: 600;
        }

        .status-message.success {
            background: #c6f6d5;
            color: #22543d;
            border: 1px solid #9ae6b4;
        }

        .status-message.error {
            background: #fed7d7;
            color: #742a2a;
            border: 1px solid #feb2b2;
        }

        .status-message.info {
            background: #bee3f8;
            color: #2a4365;
            border: 1px solid #90cdf4;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
            color: #718096;
        }

        .loading.show {
            display: block;
        }

        .spinner {
            border: 3px solid #e2e8f0;
            border-top: 3px solid #4299e1;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .bulk-operations {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .file-input {
            position: relative;
            display: inline-block;
            cursor: pointer;
            background: #4299e1;
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .file-input:hover {
            background: #3182ce;
        }

        .file-input input[type="file"] {
            position: absolute;
            left: -9999px;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .nav-buttons {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>üè† Family Calendar Admin</h1>
            <p>Manage your family's calendar, kids, and events</p>
            <p><small>‚è∞ All times are in your local timezone: <span id="timezoneInfo"></span></small></p>
            <div class="nav-buttons">
                <a href="wall.html" class="nav-btn secondary">üì∫ View Wall Display</a>
                <button class="nav-btn" onclick="refreshData()">üîÑ Refresh Data</button>
            </div>
        </div>

        <!-- Status Messages -->
        <div id="statusMessage" class="status-message" style="display: none;"></div>

        <!-- Loading Indicator -->
        <div id="loading" class="loading">
            <div class="spinner"></div>
            <div>Loading...</div>
        </div>

        <!-- Bulk Operations -->
        <div class="bulk-operations">
            <h2>
                <span class="section-icon">üìÅ</span>
                Bulk Operations
            </h2>
            <div style="display: flex; gap: 15px; flex-wrap: wrap; align-items: center;">
                <label class="file-input">
                    üì• Import CSV
                    <input type="file" id="csvFile" accept=".csv" onchange="importCSV()">
                </label>
                <label class="file-input">
                    üì• Import ICS
                    <input type="file" id="icsFile" accept=".ics" onchange="importICS()">
                </label>
                <button class="btn secondary" onclick="exportData()">üì§ Export Data</button>
                <button class="btn secondary" onclick="downloadTemplate()">üìã Download Template</button>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Kids Management -->
            <div class="section">
                <h2>
                    <span class="section-icon">üë∂</span>
                    Manage Kids
                </h2>
                
                <form id="kidForm">
                    <div class="form-group">
                        <label for="kidName">Name *</label>
                        <input type="text" id="kidName" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="kidColor">Color *</label>
                        <input type="color" id="kidColor" value="#4299e1" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="kidAvatar">Avatar URL</label>
                        <input type="url" id="kidAvatar" placeholder="https://example.com/avatar.jpg">
                    </div>
                    
                    <div class="form-group">
                        <button type="submit" class="btn" id="kidSubmitBtn">Add Kid</button>
                        <button type="button" class="btn secondary" onclick="clearKidForm()">Clear</button>
                    </div>
                </form>
                
                <div class="list-container">
                    <div id="kidsList">
                        <div class="loading show">Loading kids...</div>
                    </div>
                </div>
            </div>

            <!-- Events Management -->
            <div class="section">
                <h2>
                    <span class="section-icon">üìÖ</span>
                    Manage Events
                </h2>
                
                <form id="eventForm">
                    <div class="form-group">
                        <label for="eventTitle">Title *</label>
                        <input type="text" id="eventTitle" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="eventLocation">Location</label>
                        <input type="text" id="eventLocation">
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="eventStartDate">Start Date *</label>
                            <input type="date" id="eventStartDate" required>
                        </div>
                        <div class="form-group">
                            <label for="eventStartTime">Start Time * <small>(Local Time)</small></label>
                            <input type="time" id="eventStartTime" required>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="eventEndDate">End Date *</label>
                            <input type="date" id="eventEndDate" required>
                        </div>
                        <div class="form-group">
                            <label for="eventEndTime">End Time * <small>(Local Time)</small></label>
                            <input type="time" id="eventEndTime" required>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="eventKids">Kids</label>
                        <select id="eventKids" multiple>
                            <!-- Populated dynamically -->
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="eventCategory">Category *</label>
                        <select id="eventCategory" required>
                            <option value="family">Family</option>
                            <option value="school">School</option>
                            <option value="after-school">After School</option>
                            <option value="sports">Sports</option>
                            <option value="education">Education</option>
                            <option value="health">Health</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="eventRRule">Recurring Rule (RRULE)</label>
                        <input type="text" id="eventRRule" placeholder="FREQ=WEEKLY;BYDAY=MO,WE,FR">
                    </div>
                    
                    <div class="form-group">
                        <button type="submit" class="btn" id="eventSubmitBtn">Add Event</button>
                        <button type="button" class="btn secondary" onclick="clearEventForm()">Clear</button>
                    </div>
                </form>
                
                <div class="list-container">
                    <div id="eventsList">
                        <div class="loading show">Loading events...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const API_BASE_URL = 'http://localhost:8000/v1';
        
        // Global state
        let kids = [];
        let events = [];
        let editingKidId = null;
        let editingEventId = null;

        // Initialize the application
        async function init() {
            try {
                showLoading(true);
                
                // Set timezone information
                const timezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
                const offset = new Date().getTimezoneOffset();
                const offsetHours = Math.abs(offset) / 60;
                const offsetSign = offset <= 0 ? '+' : '-';
                const offsetString = `UTC${offsetSign}${offsetHours}`;
                document.getElementById('timezoneInfo').textContent = `${timezone} (${offsetString})`;
                
                await loadKids();
                await loadEvents();
                setupEventListeners();
                showLoading(false);
                showStatus('Admin dashboard loaded successfully!', 'success');
            } catch (error) {
                showLoading(false);
                showStatus('Failed to load admin dashboard: ' + error.message, 'error');
            }
        }

        // Show/hide loading indicator
        function showLoading(show) {
            const loading = document.getElementById('loading');
            if (show) {
                loading.classList.add('show');
            } else {
                loading.classList.remove('show');
            }
        }

        // Show status message
        function showStatus(message, type = 'info') {
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.textContent = message;
            statusDiv.className = `status-message ${type}`;
            statusDiv.style.display = 'block';
            
            // Auto-hide after 5 seconds
            setTimeout(() => {
                statusDiv.style.display = 'none';
            }, 5000);
        }

        // Load kids data
        async function loadKids() {
            try {
                const response = await fetch(`${API_BASE_URL}/kids/`);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                kids = await response.json();
                renderKidsList();
                updateEventKidsSelect();
            } catch (error) {
                console.error('Failed to load kids:', error);
                throw error;
            }
        }

        // Load events data
        async function loadEvents() {
            try {
                const response = await fetch(`${API_BASE_URL}/events/`);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                events = await response.json();
                renderEventsList();
            } catch (error) {
                console.error('Failed to load events:', error);
                throw error;
            }
        }

        // Render kids list
        function renderKidsList() {
            const container = document.getElementById('kidsList');
            
            if (kids.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: #718096; padding: 20px;">No kids added yet</div>';
                return;
            }
            
            container.innerHTML = kids.map(kid => `
                <div class="list-item">
                    <div class="list-item-info">
                        <div class="list-item-title">
                            <span class="color-preview" style="background-color: ${kid.color}"></span>
                            ${kid.name}
                        </div>
                        <div class="list-item-details">
                            Color: ${kid.color} | Avatar: ${kid.avatar ? 'Set' : 'None'}
                        </div>
                    </div>
                    <div class="list-item-actions">
                        <button class="btn small secondary" onclick="editKid(${kid.id})">Edit</button>
                        <button class="btn small danger" onclick="deleteKid(${kid.id})">Delete</button>
                    </div>
                </div>
            `).join('');
        }

        // Render events list
        function renderEventsList() {
            const container = document.getElementById('eventsList');
            
            if (events.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: #718096; padding: 20px;">No events added yet</div>';
                return;
            }
            
            container.innerHTML = events.map(event => {
                const startDate = new Date(event.start_utc);
                const endDate = new Date(event.end_utc);
                const eventKids = event.kid_ids ? event.kid_ids.map(id => {
                    const kid = kids.find(k => k.id == id);
                    return kid ? kid.name : `Kid ${id}`;
                }).join(', ') : 'None';
                
                return `
                    <div class="list-item">
                        <div class="list-item-info">
                            <div class="list-item-title">${event.title}</div>
                            <div class="list-item-details">
                                ${startDate.toLocaleDateString()} ${startDate.toLocaleTimeString()} - ${endDate.toLocaleTimeString()}<br>
                                ${event.location || 'No location'} | ${event.category} | Kids: ${eventKids}
                            </div>
                        </div>
                        <div class="list-item-actions">
                            <button class="btn small secondary" onclick="editEvent(${event.id})">Edit</button>
                            <button class="btn small danger" onclick="deleteEvent(${event.id})">Delete</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Update event kids select options
        function updateEventKidsSelect() {
            const select = document.getElementById('eventKids');
            select.innerHTML = kids.map(kid => 
                `<option value="${kid.id}">${kid.name}</option>`
            ).join('');
        }

        // Setup event listeners
        function setupEventListeners() {
            // Kid form submission
            document.getElementById('kidForm').addEventListener('submit', handleKidSubmit);
            
            // Event form submission
            document.getElementById('eventForm').addEventListener('submit', handleEventSubmit);
        }

        // Handle kid form submission
        async function handleKidSubmit(e) {
            e.preventDefault();
            
            const formData = {
                name: document.getElementById('kidName').value.trim(),
                color: document.getElementById('kidColor').value,
                avatar: document.getElementById('kidAvatar').value.trim() || null
            };
            
            try {
                showLoading(true);
                
                if (editingKidId) {
                    // Update existing kid
                    const response = await fetch(`${API_BASE_URL}/kids/${editingKidId}`, {
                        method: 'PATCH',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(formData)
                    });
                    
                    if (!response.ok) throw new Error(`HTTP ${response.status}`);
                    
                    showStatus('Kid updated successfully!', 'success');
                    editingKidId = null;
                } else {
                    // Create new kid
                    const response = await fetch(`${API_BASE_URL}/kids/`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(formData)
                    });
                    
                    if (!response.ok) throw new Error(`HTTP ${response.status}`);
                    
                    showStatus('Kid added successfully!', 'success');
                }
                
                await loadKids();
                clearKidForm();
                showLoading(false);
                
            } catch (error) {
                showLoading(false);
                showStatus('Failed to save kid: ' + error.message, 'error');
            }
        }

        // Handle event form submission
        async function handleEventSubmit(e) {
            e.preventDefault();
            
            const startDate = document.getElementById('eventStartDate').value;
            const startTime = document.getElementById('eventStartTime').value;
            const endDate = document.getElementById('eventEndDate').value;
            const endTime = document.getElementById('eventEndTime').value;
            
            // Convert local time to UTC properly
            const startLocal = new Date(`${startDate}T${startTime}`);
            const endLocal = new Date(`${endDate}T${endTime}`);
            
            // Convert to UTC by adjusting for timezone offset
            const startUtc = new Date(startLocal.getTime() - (startLocal.getTimezoneOffset() * 60000)).toISOString();
            const endUtc = new Date(endLocal.getTime() - (endLocal.getTimezoneOffset() * 60000)).toISOString();
            
            const selectedKids = Array.from(document.getElementById('eventKids').selectedOptions)
                .map(option => option.value);
            
            const formData = {
                title: document.getElementById('eventTitle').value.trim(),
                location: document.getElementById('eventLocation').value.trim() || null,
                start_utc: startUtc,
                end_utc: endUtc,
                kid_ids: selectedKids.length > 0 ? selectedKids : null,
                category: document.getElementById('eventCategory').value,
                source: 'manual',
                rrule: document.getElementById('eventRRule').value.trim() || null
            };
            
            try {
                showLoading(true);
                
                if (editingEventId) {
                    // Update existing event
                    const response = await fetch(`${API_BASE_URL}/events/${editingEventId}`, {
                        method: 'PATCH',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(formData)
                    });
                    
                    if (!response.ok) throw new Error(`HTTP ${response.status}`);
                    
                    showStatus('Event updated successfully!', 'success');
                    editingEventId = null;
                } else {
                    // Create new event
                    const response = await fetch(`${API_BASE_URL}/events/`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(formData)
                    });
                    
                    if (!response.ok) throw new Error(`HTTP ${response.status}`);
                    
                    showStatus('Event added successfully!', 'success');
                }
                
                await loadEvents();
                clearEventForm();
                showLoading(false);
                
            } catch (error) {
                showLoading(false);
                showStatus('Failed to save event: ' + error.message, 'error');
            }
        }

        // Edit kid
        function editKid(kidId) {
            const kid = kids.find(k => k.id === kidId);
            if (!kid) return;
            
            document.getElementById('kidName').value = kid.name;
            document.getElementById('kidColor').value = kid.color;
            document.getElementById('kidAvatar').value = kid.avatar || '';
            
            editingKidId = kidId;
            document.getElementById('kidSubmitBtn').textContent = 'Update Kid';
            
            // Scroll to form
            document.getElementById('kidForm').scrollIntoView({ behavior: 'smooth' });
        }

        // Edit event
        function editEvent(eventId) {
            const event = events.find(e => e.id === eventId);
            if (!event) return;
            
            const startDate = new Date(event.start_utc);
            const endDate = new Date(event.end_utc);
            
            document.getElementById('eventTitle').value = event.title;
            document.getElementById('eventLocation').value = event.location || '';
            // Convert UTC times to local time for form display
            const startLocal = new Date(startDate.getTime() + (startDate.getTimezoneOffset() * 60000));
            const endLocal = new Date(endDate.getTime() + (endDate.getTimezoneOffset() * 60000));
            
            document.getElementById('eventStartDate').value = startLocal.toISOString().split('T')[0];
            document.getElementById('eventStartTime').value = startLocal.toTimeString().slice(0, 5);
            document.getElementById('eventEndDate').value = endLocal.toISOString().split('T')[0];
            document.getElementById('eventEndTime').value = endLocal.toTimeString().slice(0, 5);
            document.getElementById('eventCategory').value = event.category;
            document.getElementById('eventRRule').value = event.rrule || '';
            
            // Select kids
            const kidsSelect = document.getElementById('eventKids');
            Array.from(kidsSelect.options).forEach(option => {
                option.selected = event.kid_ids && event.kid_ids.includes(option.value);
            });
            
            editingEventId = eventId;
            document.getElementById('eventSubmitBtn').textContent = 'Update Event';
            
            // Scroll to form
            document.getElementById('eventForm').scrollIntoView({ behavior: 'smooth' });
        }

        // Delete kid
        async function deleteKid(kidId) {
            if (!confirm('Are you sure you want to delete this kid? This will also remove them from all events.')) {
                return;
            }
            
            try {
                showLoading(true);
                
                const response = await fetch(`${API_BASE_URL}/kids/${kidId}`, {
                    method: 'DELETE'
                });
                
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                showStatus('Kid deleted successfully!', 'success');
                await loadKids();
                await loadEvents(); // Refresh events to update kid references
                showLoading(false);
                
            } catch (error) {
                showLoading(false);
                showStatus('Failed to delete kid: ' + error.message, 'error');
            }
        }

        // Delete event
        async function deleteEvent(eventId) {
            if (!confirm('Are you sure you want to delete this event?')) {
                return;
            }
            
            try {
                showLoading(true);
                
                const response = await fetch(`${API_BASE_URL}/events/${eventId}`, {
                    method: 'DELETE'
                });
                
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                showStatus('Event deleted successfully!', 'success');
                await loadEvents();
                showLoading(false);
                
            } catch (error) {
                showLoading(false);
                showStatus('Failed to delete event: ' + error.message, 'error');
            }
        }

        // Clear kid form
        function clearKidForm() {
            document.getElementById('kidForm').reset();
            document.getElementById('kidColor').value = '#4299e1';
            editingKidId = null;
            document.getElementById('kidSubmitBtn').textContent = 'Add Kid';
        }

        // Clear event form
        function clearEventForm() {
            document.getElementById('eventForm').reset();
            editingEventId = null;
            document.getElementById('eventSubmitBtn').textContent = 'Add Event';
        }

        // Refresh all data
        async function refreshData() {
            try {
                showLoading(true);
                await loadKids();
                await loadEvents();
                showLoading(false);
                showStatus('Data refreshed successfully!', 'success');
            } catch (error) {
                showLoading(false);
                showStatus('Failed to refresh data: ' + error.message, 'error');
            }
        }

        // Import CSV
        async function importCSV() {
            const fileInput = document.getElementById('csvFile');
            const file = fileInput.files[0];
            if (!file) return;
            
            try {
                showLoading(true);
                
                const formData = new FormData();
                formData.append('file', file);
                
                const response = await fetch(`${API_BASE_URL}/imports/csv`, {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const result = await response.json();
                showStatus(`CSV imported successfully! ${result.created} events created.`, 'success');
                await loadEvents();
                showLoading(false);
                
            } catch (error) {
                showLoading(false);
                showStatus('Failed to import CSV: ' + error.message, 'error');
            }
            
            // Reset file input
            fileInput.value = '';
        }

        // Import ICS
        async function importICS() {
            const fileInput = document.getElementById('icsFile');
            const file = fileInput.files[0];
            if (!file) return;
            
            try {
                showLoading(true);
                
                const formData = new FormData();
                formData.append('file', file);
                
                const response = await fetch(`${API_BASE_URL}/imports/ics`, {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const result = await response.json();
                showStatus(`ICS imported successfully! ${result.created} events created.`, 'success');
                await loadEvents();
                showLoading(false);
                
            } catch (error) {
                showLoading(false);
                showStatus('Failed to import ICS: ' + error.message, 'error');
            }
            
            // Reset file input
            fileInput.value = '';
        }

        // Export data
        function exportData() {
            const data = {
                kids: kids,
                events: events,
                exported_at: new Date().toISOString()
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `family-calendar-export-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showStatus('Data exported successfully!', 'success');
        }

        // Download template
        function downloadTemplate() {
            const template = `title,location,start_date,start_time,end_date,end_time,kid_ids,category,rrule
"Piano Lesson","Music Studio","2025-09-08","15:00","2025-09-08","16:00","1","education",""
"Soccer Practice","Community Center","2025-09-08","16:30","2025-09-08","18:00","1,2","sports","FREQ=WEEKLY;BYDAY=MO,WE,FR"`;
            
            const blob = new Blob([template], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'family-calendar-template.csv';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showStatus('Template downloaded successfully!', 'success');
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
