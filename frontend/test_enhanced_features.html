<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced Features Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }
        .test-container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin-bottom: 30px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .test-section h3 {
            margin-top: 0;
            color: #333;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-family: monospace;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .status.warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        .metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 15px 0;
        }
        .metric {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            text-align: center;
        }
        .metric-value {
            font-size: 24px;
            font-weight: bold;
            color: #007bff;
        }
        .metric-label {
            font-size: 12px;
            color: #6c757d;
            margin-top: 5px;
        }
        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .test-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            border: 1px solid #e9ecef;
        }
        .test-card h4 {
            margin-top: 0;
            color: #2c3e50;
        }
        .test-result {
            margin: 10px 0;
            padding: 8px;
            border-radius: 4px;
            font-size: 14px;
        }
        .test-result.pass {
            background: #d4edda;
            color: #155724;
        }
        .test-result.fail {
            background: #f8d7da;
            color: #721c24;
        }
        .test-result.pending {
            background: #fff3cd;
            color: #856404;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>Enhanced Features Test Suite</h1>
        <p>Comprehensive testing of Task 9: Event Rendering & Layout features</p>

        <div class="test-section">
            <h3>Test Metrics</h3>
            <div class="metrics">
                <div class="metric">
                    <div class="metric-value" id="totalTests">0</div>
                    <div class="metric-label">Total Tests</div>
                </div>
                <div class="metric">
                    <div class="metric-value" id="passedTests">0</div>
                    <div class="metric-label">Passed</div>
                </div>
                <div class="metric">
                    <div class="metric-value" id="failedTests">0</div>
                    <div class="metric-label">Failed</div>
                </div>
                <div class="metric">
                    <div class="metric-value" id="renderTime">0ms</div>
                    <div class="metric-label">Render Time</div>
                </div>
            </div>
        </div>

        <div class="test-section">
            <h3>Test Controls</h3>
            <button onclick="runAllTests()">Run All Tests</button>
            <button onclick="testOverlappingEvents()">Test Overlapping Events</button>
            <button onclick="testEventPositioning()">Test Event Positioning</button>
            <button onclick="testTimeRangeExpansion()">Test Time Range Expansion</button>
            <button onclick="testEventCardDisplay()">Test Event Card Display</button>
            <button onclick="testResponsiveLayout()">Test Responsive Layout</button>
            <button onclick="testPerformance()">Test Performance</button>
            <button onclick="openEnhancedWall()">Open Enhanced Wall Display</button>
        </div>

        <div class="test-section">
            <h3>Test Results</h3>
            <div class="test-grid" id="testResults">
                <!-- Test results will be populated here -->
            </div>
        </div>
    </div>

    <script>
        const API_BASE_URL = 'http://localhost:8000/v1';
        let testResults = {
            total: 0,
            passed: 0,
            failed: 0
        };

        function updateMetrics() {
            document.getElementById('totalTests').textContent = testResults.total;
            document.getElementById('passedTests').textContent = testResults.passed;
            document.getElementById('failedTests').textContent = testResults.failed;
        }

        function addTestResult(testName, result, details = '') {
            testResults.total++;
            if (result === 'pass') {
                testResults.passed++;
            } else if (result === 'fail') {
                testResults.failed++;
            }

            const testResultsContainer = document.getElementById('testResults');
            const testCard = document.createElement('div');
            testCard.className = 'test-card';
            testCard.innerHTML = `
                <h4>${testName}</h4>
                <div class="test-result ${result}">
                    ${result === 'pass' ? '✅ PASS' : result === 'fail' ? '❌ FAIL' : '⏳ PENDING'}
                </div>
                ${details ? `<div style="font-size: 12px; color: #6c757d; margin-top: 5px;">${details}</div>` : ''}
            `;
            testResultsContainer.appendChild(testCard);
            updateMetrics();
        }

        async function runAllTests() {
            // Clear previous results
            document.getElementById('testResults').innerHTML = '';
            testResults = { total: 0, passed: 0, failed: 0 };
            updateMetrics();

            // Run all tests
            await testOverlappingEvents();
            await testEventPositioning();
            await testTimeRangeExpansion();
            await testEventCardDisplay();
            await testResponsiveLayout();
            await testPerformance();
        }

        async function testOverlappingEvents() {
            try {
                addTestResult('Overlapping Events Detection', 'pending', 'Testing overlap detection algorithm...');
                
                // Test overlap detection logic with mock data (no API calls needed)
                const testEvents = [
                    {
                        title: 'Test Event 1',
                        start_utc: '2025-09-05T09:00:00Z', // 9:00 AM
                        end_utc: '2025-09-05T10:00:00Z'   // 10:00 AM
                    },
                    {
                        title: 'Test Event 2',
                        start_utc: '2025-09-05T09:30:00Z', // 9:30 AM
                        end_utc: '2025-09-05T10:30:00Z'   // 10:30 AM
                    }
                ];

                // Test overlap detection logic
                const overlapDetected = detectOverlaps(testEvents);
                const hasOverlaps = overlapDetected.some(group => group.length > 1);
                
                if (hasOverlaps) {
                    addTestResult('Overlapping Events Detection', 'pass', `Detected ${overlapDetected.length} overlap groups`);
                } else {
                    addTestResult('Overlapping Events Detection', 'fail', 'Failed to detect overlapping events');
                }

            } catch (error) {
                addTestResult('Overlapping Events Detection', 'fail', `Error: ${error.message}`);
            }
        }

        async function testEventPositioning() {
            try {
                addTestResult('Event Positioning Accuracy', 'pending', 'Testing event positioning...');
                
                // Test positioning logic
                const testEvent = {
                    start_utc: '2025-09-05T10:00:00Z',
                    end_utc: '2025-09-05T11:00:00Z'
                };
                
                const startTime = new Date(testEvent.start_utc).getUTCHours() + new Date(testEvent.start_utc).getUTCMinutes() / 60;
                const endTime = new Date(testEvent.end_utc).getUTCHours() + new Date(testEvent.end_utc).getUTCMinutes() / 60;
                
                const TIME_START = 6;
                const TIME_SLOT_HEIGHT = 40;
                const expectedTopOffset = (startTime - TIME_START) * TIME_SLOT_HEIGHT;
                const expectedHeight = (endTime - startTime) * TIME_SLOT_HEIGHT;
                
                // 10:00 AM = 4 hours from 6:00 AM = 160px, 1 hour = 40px
                if (expectedTopOffset === 160 && expectedHeight === 40) {
                    addTestResult('Event Positioning Accuracy', 'pass', `Top: ${expectedTopOffset}px, Height: ${expectedHeight}px`);
                } else {
                    addTestResult('Event Positioning Accuracy', 'fail', `Expected Top: 160px, Height: 40px, Got Top: ${expectedTopOffset}px, Height: ${expectedHeight}px`);
                }

            } catch (error) {
                addTestResult('Event Positioning Accuracy', 'fail', `Error: ${error.message}`);
            }
        }

        async function testTimeRangeExpansion() {
            try {
                addTestResult('Time Range Expansion', 'pending', 'Testing time range expansion...');
                
                // Test if events outside 8:00-22:00 are handled
                const outsideRangeEvent = {
                    start_utc: '2025-09-05T06:00:00Z', // 6:00 AM
                    end_utc: '2025-09-05T07:00:00Z'   // 7:00 AM
                };
                
                const startTime = new Date(outsideRangeEvent.start_utc).getHours();
                const isOutsideRange = startTime < 8 || startTime > 22;
                
                if (isOutsideRange) {
                    addTestResult('Time Range Expansion', 'pass', 'Correctly identified outside range event');
                } else {
                    addTestResult('Time Range Expansion', 'fail', 'Failed to identify outside range event');
                }

            } catch (error) {
                addTestResult('Time Range Expansion', 'fail', `Error: ${error.message}`);
            }
        }

        async function testEventCardDisplay() {
            try {
                addTestResult('Event Card Display', 'pending', 'Testing event card information...');
                
                // Test event card content structure
                const testEvent = {
                    title: 'Test Event',
                    location: 'Test Location',
                    category: 'family',
                    source: 'manual',
                    start_utc: '2025-09-05T10:00:00Z',
                    end_utc: '2025-09-05T11:00:00Z'
                };
                
                const hasTitle = testEvent.title && testEvent.title.length > 0;
                const hasTime = testEvent.start_utc && testEvent.end_utc;
                const hasCategory = testEvent.category && testEvent.category.length > 0;
                
                if (hasTitle && hasTime && hasCategory) {
                    addTestResult('Event Card Display', 'pass', 'All required fields present');
                } else {
                    addTestResult('Event Card Display', 'fail', 'Missing required fields');
                }

            } catch (error) {
                addTestResult('Event Card Display', 'fail', `Error: ${error.message}`);
            }
        }

        async function testResponsiveLayout() {
            try {
                addTestResult('Responsive Layout', 'pending', 'Testing responsive design...');
                
                // Test responsive breakpoints
                const screenWidth = window.innerWidth;
                let responsiveTest = 'pass';
                let details = '';
                
                if (screenWidth < 480) {
                    details = 'Mobile layout (< 480px)';
                } else if (screenWidth < 768) {
                    details = 'Tablet layout (480px - 768px)';
                } else {
                    details = 'Desktop layout (> 768px)';
                }
                
                // Test if CSS Grid is supported
                const gridSupported = CSS.supports('display', 'grid');
                if (!gridSupported) {
                    responsiveTest = 'fail';
                    details += ' - CSS Grid not supported';
                }
                
                addTestResult('Responsive Layout', responsiveTest, details);

            } catch (error) {
                addTestResult('Responsive Layout', 'fail', `Error: ${error.message}`);
            }
        }

        async function testPerformance() {
            try {
                addTestResult('Performance Test', 'pending', 'Testing render performance...');
                
                const startTime = performance.now();
                
                // Simulate rendering 100 events
                const events = [];
                for (let i = 0; i < 100; i++) {
                    events.push({
                        id: i,
                        title: `Test Event ${i}`,
                        start_utc: '2025-09-05T10:00:00Z',
                        end_utc: '2025-09-05T11:00:00Z',
                        category: 'family',
                        source: 'manual'
                    });
                }
                
                // Simulate event rendering
                events.forEach(event => {
                    // Simulate DOM operations
                    const element = document.createElement('div');
                    element.className = `event-card ${event.category}`;
                    element.textContent = event.title;
                });
                
                const endTime = performance.now();
                const renderTime = endTime - startTime;
                
                document.getElementById('renderTime').textContent = `${Math.round(renderTime)}ms`;
                
                if (renderTime < 1000) { // Less than 1 second
                    addTestResult('Performance Test', 'pass', `Render time: ${Math.round(renderTime)}ms (target: < 1000ms)`);
                } else {
                    addTestResult('Performance Test', 'fail', `Render time: ${Math.round(renderTime)}ms (target: < 1000ms)`);
                }

            } catch (error) {
                addTestResult('Performance Test', 'fail', `Error: ${error.message}`);
            }
        }

        function openEnhancedWall() {
            try {
                const wallWindow = window.open('wall_enhanced.html', '_blank', 'width=1400,height=900');
                if (wallWindow) {
                    addTestResult('Enhanced Wall Display', 'pass', 'Successfully opened in new window');
                } else {
                    addTestResult('Enhanced Wall Display', 'fail', 'Failed to open (popup blocked?)');
                }
            } catch (error) {
                addTestResult('Enhanced Wall Display', 'fail', `Error: ${error.message}`);
            }
        }

        // Overlap detection algorithm (same as in wall_enhanced.html)
        function detectOverlaps(events) {
            if (events.length === 0) return [];
            
            const sortedEvents = events.sort((a, b) => {
                return new Date(a.start_utc) - new Date(b.start_utc);
            });
            
            const groups = [];
            let currentGroup = [sortedEvents[0]];
            
            for (let i = 1; i < sortedEvents.length; i++) {
                const currentEvent = sortedEvents[i];
                const lastEventInGroup = currentGroup[currentGroup.length - 1];
                
                const currentStart = new Date(currentEvent.start_utc);
                const lastEnd = new Date(lastEventInGroup.end_utc);
                
                if (currentStart < lastEnd) {
                    currentGroup.push(currentEvent);
                } else {
                    groups.push(currentGroup);
                    currentGroup = [currentEvent];
                }
            }
            
            groups.push(currentGroup);
            return groups;
        }

        // Initialize
        window.addEventListener('DOMContentLoaded', () => {
            updateMetrics();
        });
    </script>
</body>
</html>
